{% extends "base.html" %}
{% block title %}{{ movie.TITLE }}{% endblock %}
{% block content %}
    <h2>{{ movie.TITLE }} ({{ movie.RELEASE_YEAR }})</h2>
    <p><strong>Director:</strong> {{ movie.DIRECTOR }}</p>
    <p><strong>Genre:</strong> {{ movie.GENRE }}</p>
    <p><strong>Runtime:</strong> {{ movie.RUNTIME }} min</p>
    <p style="font-size: 1.5em;">‚≠ê <strong>Average Rating:</strong> {{ avg_rating }} / 10</p>
    
    <hr>
    
    {% if session.user_id %}
    <h3>Submit Your Review</h3>
    <form id="reviewForm">
        <input type="hidden" id="movie_id" value="{{ movie.MOVIE_ID }}">
        <label for="rating">Rating (1-10):</label>
        <input type="number" id="rating" name="rating" min="1" max="10" required><br><br>
        <label for="review_text">Review:</label><br>
        <textarea id="review_text" name="review_text" rows="4" cols="50"></textarea><br><br>
        <button type="submit">Post Review</button>
        <p id="message" style="margin-top: 10px;"></p>
    </form>
    <hr>
    {% endif %}

    <h3>All Reviews ({{ reviews|length }})</h3>
    {% for review in reviews %}
    <div class="review-box">
        <p><strong>User:</strong> {{ review.USERNAME }} | <strong>Rating:</strong> {{ review.RATING }}/10</p>
        <p>{{ review.REVIEW_TEXT }}</p>
        <small>Posted on {{ review.REVIEW_DATE.strftime('%Y-%m-%d') }}</small>
    </div>
    {% endfor %}

    <script>
        document.getElementById('reviewForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const form = event.target;
            const messageElement = document.getElementById('message');

            const data = {
                movie_id: parseInt(form.movie_id.value),
                rating: parseInt(form.rating.value),
                review_text: form.review_text.value
            };

            fetch('/api/submit_review', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                messageElement.textContent = result.message;
                if (response.ok) {
                    messageElement.style.color = 'green';
                    // Reload or update reviews on success
                    window.location.reload(); 
                } else {
                    messageElement.style.color = 'red';
                }
            })
            .catch(error => {
                messageElement.textContent = 'Network error occurred.';
                messageElement.style.color = 'red';
            });
        });
    </script>
{% endblock %}